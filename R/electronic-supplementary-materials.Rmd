---
title: "Testing the generality of host-symbiont cophylogeny"
author: "Alexander Hayward, Robert Poulin & Shinichi Nakagawa"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    number_sections: no
    theme: lumen
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
subtitle: Electronic Supplementary Material
bibliography: references.bib
---

<!--- Try to add references for this!!!! --->

```{r setup, include = FALSE}
#kniter seetting
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE, # no warnings
cache = TRUE,# Cacheing to save time when kniting
tidy = TRUE
#fig.width = 9
)
```

## Setups

### Loading pacakges and custum functions

```{r}
# clearning up
rm(list=ls())

# loading packages
pacman::p_load(tidyverse, # tidy family and related pacakges below
               kableExtra, 
               gridExtra, 
               purrr,
               magrittr, # extending piping
               pander,   # nice tables
               metafor,  # package for meta-analysis
               MCMCglmm#,  # Bayeisan mixed model package
               #mi,      # missing data analysis
               #betareg   # dependance of the above
)

# getting functions 
source("../R/ESM_functions.R", chdir = TRUE)

```

#### Custum functions

NOTE!!!
We have XX custum functions: ....... 

## Supplementary Methods and Materials

### XXXX1

### XXXX2

## The Cophylogeny Dataset

### Table of the dataset

Below is the dataset used for our meta-analysis follwed by explanations of 24 variables original collected (not all varaibles were used for our analyses; variables which were neither 'directly' and 'indirectly' used in our analyses are indicated by *)

```{r}
# getting the data and formating some variables (turning chraracter vectors to factors)
# read the difference between factr() and as.factor() <https://stackoverflow.com/questions/39279238/why-use-as-factor-instead-of-just-factor>
# full_data <- read.csv("../data/2019-04-04-source-data-dat.csv", na = "NA", fileEncoding="UTF-8") %>%
#  mutate_if(is.character, as.factor)
full_data <- read_csv("../data/2019-04-04-source-data-dat.csv", na = "NA") %>% 
   mutate_if(is.character, as.factor)


# making a scrollable table
kable(full_data, "html") %>%
  kable_styling("striped", position = "left") %>%
  scroll_box(width = "100%", height = "500px")
```

A. __authors__: The authors of the study and the date (citation form).

B. __year__: Year of publication of the study.

C. __host_tax_broad__:	Separation of the host group according to broader taxonomic units (e.g. vertebrate, invertebrate, microbe, plant).

D. __host_tax_fine__*:	Separation of the host group according to narrower taxonomic units (e.g. fish, tetrapod, bird, invertebrate, protist, bacterium, plant, fungus).

E. __symbiont_tax_broad__:	Separation of the symbiont group according to broader taxonomic units (e.g. vertebrate, invertebrate, microbe, plant).

F. __symbiont_tax_fine__*:	Separation of the symbiont group according to narrower taxonomic units (e.g. invertebrate, protist, virus, bacterium, fungus, plant, bird).

G. __symbiont_euk__*:	Whether the symbiont is eukaryotic (state ='yes'), or prokaryotic (state='no').

H. __symbiosis__:	The type of symbiont (e.g. parasite or mutualist). For this we followed the definition used by the authors of the study.

I. __endo_or_ecto__:	Whether the symbiont lives outside the host (i.e. is an ectosymbiont), or inside the host (i.e. is an endosymbiont).

J. __mode_of_transmission_broad__:	Whether the symbiont is transmitted vertically, horizontally, or both. For this, we followed the route of transmission specified by the authors of the study

K. __mode_of_transmission_fine__*:	A finer-scale description of the mode of transmission of the symbiont (e.g. contact, vector, bodily fluid, vertical, trophic).

L. __symbiont__*:	Shorthand description of the type of symbiont.

M. __Visiting_symbiont?__*	Whether the symbiont is resident on the host (resident), or makes visits to the host or hosts (visitor).

N. __host_tips_linked__:	The number of individual host taxa included in the cophylogenetic analysis.

O. __host_tips_linked_corrected__	The same measure as for column N, 'host_tips_linked', but reduced to only include one member of each host species. This is included because some authors include multiple individuals of the same host species. Without correction, this artificially increases the apparent number of host species included in the study.

P. __host_genera__:	A count of the number of host genera included in the cophylogenetic analysis

Q. __total_host_symbioint_links__	The total number of links between host and symbiont taxa recorded in a study. If all symbionts were strict specialists, this would equal the number of symbionts included in the study. However, because symbionts are often associated with more than one host, this value is often higher than the total number of symbionts included in the study.

R. __host_range_link_ratio__:	An estimation of symbiont host specificity, calculated by dividing the total number of links between hosts and symbionts (i.e. 'total_host_symbiont_links', column Q), by the total number of symbionts included in the study (i.e. 'symbiont_tips_linked', column T).

S. __host_range_taxonomic_breadth__:	An alternative estimation of symbiont host specificity, calculated by first summing the number of host taxonomic ranks linked to each symbiont (i.e. single host species = 1, multiple host species in the same genera = 2, multiple host genera = 3, multiple host familes = 4, multiple host orders = 5), and dividing by the total number of symbionts included in the study (i.e. 'symbiont_tips_linked', column T)

T. __symbiont_tips_linked__	The number of individual symbiont taxa included in the cophylogenetic analysis.

U. __symbiont_genera__:	A count of the number of symbiont genera included in the cophylogenetic analysis.

V. __no_randomizations__:	The number of phylogenetic randomizations performed during the cophylogenetic analysis.

W. __p_value__:	The p-value reported for the cophylogenetic analysis, representing the likelihood that host and symbtion phylogenies display cospeciation.

X. __method__:	Whether TreeMap or was used to obtain codivergence or a p value.

### Table of sample sizes

We present the number of sample size for two sepreate methods: TreeMap and Parafit (and combined) for effect sizes, papers and different levels of categorical varaibles (factors).   

```{r}
# selecting out variables, which we used for our analysis
dat <- full_data %>% select(-host_tax_fine, -symbiont_tax_fine, -symbiont_euk, -mode_of_transmission_fine, -symbiont, -`Visiting_symbiont?`)

# making a table of sample sizes for different variables
dat %>% group_by(method) %>% 
  summarise(
    `Effect sizes` = n(),
    Papers = n_distinct(authors),
    `Vertebrate hosts` = sum(host_tax_broad == "Vert", na.rm = T), # na.rm is important when NA exists
    `Invertebrate hosts` = sum(host_tax_broad == "Invert", na.rm = T),
    `Plant hosts`  = sum(host_tax_broad == "Plant", na.rm = T),
    `Microbe hosts` = sum(host_tax_broad == "Microbe", na.rm = T),
    `Vertebrate symbionts` = sum(symbiont_tax_broad  == "Vert", na.rm = T),
    `Invertebrate symbionts` = sum(symbiont_tax_broad  == "Invert", na.rm = T),
    `Plant symbionts`  = sum(symbiont_tax_broad  == "Plant", na.rm = T),
    `Microbe symbionts` = sum(symbiont_tax_broad  == "Microbe", na.rm = T),
    `Parastic relationships` = sum(symbiosis == "Parasite", na.rm = T),
    `Mutualistic relatioships` = sum(symbiosis == "Mutualist", na.rm = T),
    `Ecto-symbionts` = sum(endo_or_ecto  == "Ecto", na.rm = T),
    `Endo-symbionts` = sum(endo_or_ecto == "Endo", na.rm = T),
    `Ecto/endo-symbionts` = sum(endo_or_ecto == "Endo/Ecto", na.rm = T),
    `Horizontal transmission` = sum(mode_of_transmission_broad  == "horizontal", na.rm = T),
    `Vertical transmission` = sum(mode_of_transmission_broad == "vertical", na.rm = T),
    `Horizontal/vertical-transmission` = sum(mode_of_transmission_broad == "both", na.rm = T)
  ) -> n_table1

# transposing the table and creating that table and adding a correct number of the papers for `Combined`
n_authors <- n_distinct(dat$authors) # the total number of papers
n_table2 <-t(n_table1[,-1])
colnames(n_table2) <- n_table1$method
n_table2 %>% as_tibble(rownames = "Number") %>% 
  mutate(Combined = Parafit + TreeMap, Combined = replace(Combined, 2, n_authors)) %>%  
  rename("Number of" = "Number", "Parafit (n)" = "Parafit", "TreeMap (n)" = "TreeMap",  "Combined (n)" = "Combined") %>% 
  kable() %>% kable_styling("striped", position = "left") %>%
  scroll_box(width = "100%", height = "250px")
  #pander(split.cell = 40, split.table = Inf) # not as nice as kable
```
Note that for the numbers of papers do not add up (TreeMap + Parafit $\neq$ Combined) becuase `r sum(n_table2[2,]) - length(unique(dat$authors))`  papers used both TreeMap and Parafit methods (the term "papers" here is our variable `auhtors`)

### Missing data patterns

Here we have the number of missing data (cells) for all the varaibles used in the analysis below.

```{r}
# summaring missingness in our dataset
# funs(sum(is.na(.))) needs to be in funs as is.na has "." = each column
dat %>% summarise_all(~sum(is.na(.))) %>% # map(~sum(is.na(.)) # this is an alterantive way 
  t() %>% as_tibble(rownames = "Variable") %>% 
  rename("Number of missing data (n)" = "V1") %>% 
  #pander(split.cell = 40, split.table = Inf)
  kable() %>% kable_styling("striped", position = "left") %>%
  scroll_box(width = "50%", height = "250px")

# an alternative method using the mi package
#missing_data_tbl <- missing_data.frame(as.data.frame(data))
#show(missing_data_tbl) 
```

## Meta-analysis

### Calculating effect sizes

Here, we create our effect size (correlation coefficent *r* and its Fisher's z transformaiton *Zr*) from p values and associated sample sizes. We used the sum of `host_tips_linked_corrected` and `symbiont_tips_linked` as our sample size (i.e., the number of both host and symbiont species) for each effect size (an indicator of congruence). Also, we creat a column with unique ID for each observation (i.e. an observation level random effect), termed `observation`, which is required for the `rma.mv` function in `metafor`.

NOTE!!!
* creating Zr and sample size - done
* we only use corrected sample size..(need to write about this) - done!
* Just two varaibles??? - done
* observation level random factor....
* probably make (what is this??)

* Factor re-ordering - we probably do this 

```{r}
dat %<>% 
  # getting sample size & observation level random effect
  mutate(sample_size = host_tips_linked_corrected + symbiont_tips_linked,observation = factor(1:nrow(.))) %>% 
  # calcuating effect size 
dat %<>% p_to_Zr(p_value, sample_size) 

# TODO
# some factor reordering required!!!

```


### Intercept model (meta-analytic model)

First, we checked what random effects should be put into the main model to do this we fitted two random effects `authors` and `observation`; the former term is to account for non-independence of effect sizes orginating from the same papers (i.e., `authors`). 

```{r}
# 2 random effects
model_test1 <- rma.mv(yi = Zr, V = VZr, random = list(~ 1 | authors, ~1|observation), data = dat)

# 1 random effect
model_test2 <- rma.mv(yi = Zr, V = VZr, random = ~ 1 | authors, data = dat)

```

The model (`model_test1`), which included both random factors, had a larger AIC value (`r AIC(model_test1)`) than the model with only one random effect . This is becuase `observation` hardly account any variance ($< 0.0001$) compared to `authors` ().

#### Running Multilevel Meta-analytic models with 3 datasets
```{r}

```


NOTE!!!
* Justification of the use of combined datasets....
* just do the main one for all three datasets but not others
* You need
* or we could - provide forest plots of all the three datasets???? (do it later)
* heterogeneity



## Meta-regression

### Univaraite (Uni-predictor) analyses

#### Testing 

#### 

#### Interactions between 


```{r}
dat %>% 
    # host_tax_broad*symbiosis (host_tax_symbiosis) 
  mutate(host_tax_symbiosis = str_c(host_tax_broad, symbiosis), 
         host_tax_symbiosis = ifelse(host_tax_symbiosis == "InvertNA", NA, host_tax_symbiosis),
         host_tax_symbiosis = factor(host_tax_symbiosis),
    # symbiont_tax_broad*symbiosis (symbiont_symbiosis)     
         symbiont_symbiosis = factor(str_c(symbiont_tax_broad, symbiosis)),
    # host_tax_broad*symbiont_tax_broad (host_symbiont_tax)     
         host_symbiont_tax  = factor(str_c(host_tax_broad, symbiont_tax_broad))) -> dat 

```

#### Testing specialization: 



#### 

Here are links for how to do confidence regions for rma.mv regression lines

https://www.rdocumentation.org/packages/metafor/versions/1.9-9/topics/predict.rma

https://stackoverflow.com/questions/50804464/out-of-sample-prediction-for-rma-object-in-metafor

* one-by-one analyses here...

### Addtional analyses

### Model selection (Mulit-)

## Publication Bias and Sensitivity Analysis

* boundary problems
* Time lag bias

### Recommendation
* they need to run more simuations so they do not max out!
* reanalysis of earlier trees are necessary; getting older or updated trees are required
* new studies should provide all data avaiable online so that future analysis can incorprate all avaiable data

## Acknowledgement

Much of coding materials have been borrowed from h

## Information for this R session

```{r}
sessionInfo() %>% pander()
```
